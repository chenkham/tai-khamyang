<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tai-Khamyang Shop - Traditional Dress & Culture</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='shop.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2>TAI KHAMYANG</h2>
            </div>
            <div class="nav-menu" id="navMenu">
                <a href="/" class="nav-link">Home</a>
                <a href="/dictionary" class="nav-link">Dictionary</a>
                <a href="/songs" class="nav-link">Songs</a>
                <a href="/shopnow" class="nav-link active">Shop</a>
                <a href="/about" class="nav-link">About</a>
                <a href="/admin" class="nav-link">Admin</a>
                <a href="{{ url_for('logout') }}">Logout</a>
            </div>
            <div class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <section class="shop-mode">
        <div class="container">
            <h1 class="page-title">Traditional Tai-Khamyang Marketplace</h1>
            <div class="mode-selector">
                <button class="mode-btn active" data-mode="buyer">
                    <i class="fas fa-shopping-bag"></i>
                    <span>Buyer</span>
                </button>
                <button class="mode-btn" data-mode="seller">
                    <i class="fas fa-store"></i>
                    <span>Seller</span>
                </button>
            </div>
        </div>
    </section>

    <section class="buyer-section" id="buyerSection">
        <div class="search-section">
            <div class="container">
                <div class="search-bar">
                    <div class="search-input-group">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search traditional dresses, accessories...">
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-category="all">All</button>
                        <button class="filter-btn" data-category="women">Women's Dress</button>
                        <button class="filter-btn" data-category="men">Men's Dress</button>
                        <button class="filter-btn" data-category="accessories">Accessories</button>
                        <button class="filter-btn" data-category="jewelry">Jewelry</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="products-section">
            <div class="container">
                <div class="products-grid" id="productsGrid">
                    </div>
            </div>
        </div>
    </section>

    <section class="seller-section hidden" id="sellerSection">
        <div class="container">
            <div class="seller-auth" id="sellerAuth">
                <div class="auth-container">
                    <div class="auth-tabs">
                        <button class="auth-tab active" data-form="login">Login</button>
                        <button class="auth-tab" data-form="register">Register</button>
                    </div>
                    <form class="auth-form" id="loginForm">
                        <h3>Seller Login</h3>
                        <div class="form-group">
                            <i class="fas fa-envelope"></i>
                            <input type="email" placeholder="Email Address" id="loginEmail" required>
                        </div>
                        <div class="form-group">
                            <i class="fas fa-lock"></i>
                            <input type="password" placeholder="Password" id="loginPassword" required>
                        </div>
                        <button type="submit" class="auth-btn">Login to Dashboard</button>
                    </form>
                    <form class="auth-form hidden" id="registerForm">
                        <h3>Become a Seller</h3>
                        <div class="form-group">
                            <i class="fas fa-user"></i>
                            <input type="text" placeholder="Full Name" id="regName" required>
                        </div>
                        <div class="form-group">
                            <i class="fas fa-envelope"></i>
                            <input type="email" placeholder="Email Address" id="regEmail" required>
                        </div>
                        <div class="form-group">
                            <i class="fas fa-phone"></i>
                            <input type="tel" id="regPhone" placeholder="Phone Number" required>
                        </div>
                        <div class="form-group">
                            <i class="fab fa-whatsapp"></i>
                            <input type="tel" id="regWhatsapp" placeholder="WhatsApp Number (with country code)" required>
                        </div>
                        <div class="form-group">
                            <i class="fas fa-store"></i>
                            <input type="text" placeholder="Shop Name" id="regShopName" required>
                        </div>
                        <div class="form-group">
                            <i class="fas fa-lock"></i>
                            <input type="password" placeholder="Password" id="regPassword" required>
                        </div>
                        <button type="submit" class="auth-btn">Create Seller Account</button>
                    </form>
                </div>
            </div>

            <div class="seller-dashboard hidden" id="sellerDashboard">
                <div class="dashboard-header">
                    <h2 id="dashboardWelcome">Welcome to Your Dashboard</h2>
                    <button class="logout-btn" id="sellerLogoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
                <div class="dashboard-nav">
                    <button class="dashboard-btn active" data-section="add">
                        <i class="fas fa-plus-circle"></i> Add Product
                    </button>
                    <button class="dashboard-btn" data-section="manage">
                        <i class="fas fa-boxes"></i> Manage Products
                    </button>
                </div>
                <div class="dashboard-section" id="addProductSection">
                     <h3>Add New Product</h3>
                    <form class="product-form" id="addProductForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Product Name</label>
                                <input type="text" placeholder="e.g., Traditional Tai-Khamyang Dress" id="productName" required>
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <select id="productCategory">
                                    <option value="women">Women's Dress</option>
                                    <option value="men">Men's Dress</option>
                                    <option value="accessories">Accessories</option>
                                    <option value="jewelry">Jewelry</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Price (₹)</label>
                                <input type="number" placeholder="2999" id="productPrice" required>
                            </div>
                            <div class="form-group">
                                <label>Original Price (₹)</label>
                                <input type="number" placeholder="3499" id="productOriginalPrice">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Product Description</label>
                            <textarea placeholder="Describe your traditional product..." id="productDescription" required></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Stock Quantity</label>
                                <input type="number" placeholder="10" id="productStock" required>
                            </div>
                        </div>
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </form>
                </div>
                <div class="dashboard-section hidden" id="manageProductsSection">
                    <h3>Manage Your Products</h3>
                    <div class="products-table" id="sellerProductsTable">
                        </div>
                </div>
            </div>
        </div>
    </section>

    <div class="product-detail-popup hidden" id="productDetailPopup">
        <div class="popup-overlay"></div>
        <div class="popup-content">
            <button class="close-btn" id="popupCloseBtn">
                <i class="fas fa-times"></i>
            </button>
            <div class="product-detail-content">
                <div class="product-images">
                    <img id="detailMainImage" src="" alt="Product">
                </div>
                <div class="product-details">
                    <h2 id="detailTitle"></h2>
                    <p class="detail-seller" id="detailSeller"></p>
                    <p class="detail-description" id="detailDescription"></p>
                    <div class="detail-price">
                        <span class="detail-current-price" id="detailPrice"></span>
                        <span class="detail-original-price" id="detailOriginalPrice"></span>
                    </div>
                    <div class="detail-actions">
                        <button class="buy-now-btn" id="buyOnWhatsAppBtn">
                            <i class="fab fa-whatsapp"></i> Buy on WhatsApp
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE ---
    let products = [];
    let currentUser = null;

    // --- SELECTORS ---
    const buyerSection = document.getElementById('buyerSection');
    const sellerSection = document.getElementById('sellerSection');
    const productsGrid = document.getElementById('productsGrid');
    const searchInput = document.getElementById('searchInput');
    const sellerAuth = document.getElementById('sellerAuth');
    const sellerDashboard = document.getElementById('sellerDashboard');

    // --- INITIALIZATION ---
    const initializeApp = () => {
        setupEventListeners();
        switchMode('buyer'); // Default to buyer mode
    };

    // --- EVENT LISTENERS ---
    const setupEventListeners = () => {
        // Mode Switching
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => switchMode(btn.dataset.mode));
        });

        // Buyer: Product Filtering and Search
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelector('.filter-btn.active').classList.remove('active');
                btn.classList.add('active');
                filterProducts(btn.dataset.category);
            });
        });
        searchInput.addEventListener('keyup', handleSearch);

        // Buyer: Product Click (Event Delegation)
        productsGrid.addEventListener('click', (e) => {
            const card = e.target.closest('.product-card');
            if (card) {
                const productId = card.dataset.productId;
                const product = products.find(p => p.id === productId);
                if (product) openProductDetail(product);
            }
        });

        // Seller: Auth Form Switching
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.addEventListener('click', () => showAuthForm(tab.dataset.form));
        });

        // Seller: Forms
        document.getElementById('loginForm').addEventListener('submit', handleSellerLogin);
        document.getElementById('registerForm').addEventListener('submit', handleSellerRegister);
        document.getElementById('addProductForm').addEventListener('submit', handleAddProduct);
        document.getElementById('sellerLogoutBtn').addEventListener('click', handleSellerLogout);

        // Seller: Dashboard Navigation
        document.querySelectorAll('.dashboard-btn').forEach(btn => {
            btn.addEventListener('click', () => showDashboardSection(btn.dataset.section));
        });

        // Popup Close Button
        document.getElementById('popupCloseBtn').addEventListener('click', closeProductDetail);
        document.querySelector('.product-detail-popup .popup-overlay').addEventListener('click', closeProductDetail);

        // Manage Products: Delete Button (Event Delegation)
        document.getElementById('sellerProductsTable').addEventListener('click', (e) => {
            if (e.target.closest('.delete-btn')) {
                const button = e.target.closest('.delete-btn');
                const productId = button.dataset.productId;
                if (confirm('Are you sure you want to delete this product?')) {
                    deleteProduct(productId);
                }
            }
        });
    };

    // --- MODE SWITCHING ---
    const switchMode = (mode) => {
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.mode-btn[data-mode="${mode}"]`).classList.add('active');

        if (mode === 'buyer') {
            buyerSection.classList.remove('hidden');
            sellerSection.classList.add('hidden');
            loadProducts();
        } else {
            buyerSection.classList.add('hidden');
            sellerSection.classList.remove('hidden');
            checkSellerLoginStatus();
        }
    };

    // --- BUYER FUNCTIONS ---
    const loadProducts = async () => {
        try {
            const response = await fetch('/api/products');
            const data = await response.json();
            if (data.success) {
                products = data.products;
                displayProducts(products);
            } else {
                console.error('Failed to load products:', data.message);
                productsGrid.innerHTML = '<p>Could not load products.</p>';
            }
        } catch (error) {
            console.error('Error fetching products:', error);
            productsGrid.innerHTML = '<p>Error loading products.</p>';
        }
    };

    const displayProducts = (productsToDisplay) => {
        productsGrid.innerHTML = '';
        if (productsToDisplay.length === 0) {
            productsGrid.innerHTML = '<p>No products found.</p>';
            return;
        }
        productsToDisplay.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.dataset.productId = product.id;

            const originalPrice = parseFloat(product.original_price);
            const currentPrice = parseFloat(product.price);
            let discountHTML = '';
            if (originalPrice > currentPrice) {
                const discount = Math.round(((originalPrice - currentPrice) / originalPrice) * 100);
                discountHTML = `<span class="discount">${discount}% OFF</span>`;
            }

            card.innerHTML = `
                <div class="product-image">
                    <img src="https://via.placeholder.com/300x400" alt="${product.name}">
                </div>
                <div class="product-info">
                    <h3>${product.name}</h3>
                    <p class="seller-info">By: ${product.seller_info?.business_name || 'N/A'}</p>
                    <div class="price-section">
                        <span class="current-price">₹${currentPrice.toFixed(2)}</span>
                        ${originalPrice > currentPrice ? `<span class="original-price">₹${originalPrice.toFixed(2)}</span>` : ''}
                        ${discountHTML}
                    </div>
                </div>`;
            productsGrid.appendChild(card);
        });
    };

    const handleSearch = () => {
        const query = searchInput.value.toLowerCase();
        const filtered = products.filter(p => p.name.toLowerCase().includes(query) || p.description.toLowerCase().includes(query));
        displayProducts(filtered);
    };

    const filterProducts = (category) => {
        if (category === 'all') {
            displayProducts(products);
        } else {
            const filtered = products.filter(p => p.category.toLowerCase() === category);
            displayProducts(filtered);
        }
    };

    // --- PRODUCT DETAIL POPUP ---
    const openProductDetail = (product) => {
        const popup = document.getElementById('productDetailPopup');
        document.getElementById('detailTitle').textContent = product.name;
        document.getElementById('detailDescription').textContent = product.description;
        document.getElementById('detailSeller').textContent = `Sold by: ${product.seller_info?.business_name || 'N/A'}`;
        document.getElementById('detailPrice').textContent = `₹${parseFloat(product.price).toFixed(2)}`;

        const originalPriceEl = document.getElementById('detailOriginalPrice');
        if (product.original_price > product.price) {
            originalPriceEl.textContent = `₹${parseFloat(product.original_price).toFixed(2)}`;
            originalPriceEl.style.display = 'inline';
        } else {
            originalPriceEl.style.display = 'none';
        }

        // WhatsApp button logic
        const buyBtn = document.getElementById('buyOnWhatsAppBtn');
        if (product.seller_info?.whatsapp) {
            const message = encodeURIComponent(`Hi, I'm interested in your product: ${product.name} (Price: ₹${product.price})`);
            const whatsappUrl = `https://wa.me/${product.seller_info.whatsapp}?text=${message}`;
            buyBtn.onclick = () => window.open(whatsappUrl, '_blank');
            buyBtn.disabled = false;
        } else {
            buyBtn.onclick = null;
            buyBtn.disabled = true;
        }

        popup.classList.remove('hidden');
    };

    const closeProductDetail = () => {
        document.getElementById('productDetailPopup').classList.add('hidden');
    };


    // --- SELLER FUNCTIONS ---
    const checkSellerLoginStatus = () => {
        if (currentUser) {
            showSellerDashboard();
        } else {
            showSellerAuth();
        }
    };

    const showSellerAuth = () => {
        sellerAuth.classList.remove('hidden');
        sellerDashboard.classList.add('hidden');
        showAuthForm('login');
    };

    const showSellerDashboard = () => {
        sellerAuth.classList.add('hidden');
        sellerDashboard.classList.remove('hidden');
        document.getElementById('dashboardWelcome').textContent = `Welcome, ${currentUser.business_name}`;
        showDashboardSection('add'); // Default to 'add product' view
        loadSellerProducts();
    };

    const showAuthForm = (formType) => {
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.auth-tab[data-form="${formType}"]`).classList.add('active');
        document.querySelectorAll('.auth-form').forEach(f => f.classList.add('hidden'));
        document.getElementById(`${formType}Form`).classList.remove('hidden');
    };

    const handleSellerLogin = async (e) => {
        e.preventDefault();
        const data = {
            email: document.getElementById('loginEmail').value,
            password: document.getElementById('loginPassword').value,
        };
        try {
            const response = await fetch('/api/seller/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.success) {
                currentUser = result.seller;
                showSellerDashboard();
            } else {
                alert(`Login failed: ${result.message}`);
            }
        } catch (error) {
            alert('An error occurred during login.');
        }
    };

    const handleSellerRegister = async (e) => {
        e.preventDefault();
        const data = {
            fullName: document.getElementById('regName').value,
            email: document.getElementById('regEmail').value,
            phone: document.getElementById('regPhone').value,
            whatsapp: document.getElementById('regWhatsapp').value,
            shopName: document.getElementById('regShopName').value,
            password: document.getElementById('regPassword').value
        };
        try {
            const response = await fetch('/api/seller/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.success) {
                alert('Registration successful! Please login.');
                showAuthForm('login');
            } else {
                alert(`Registration failed: ${result.message}`);
            }
        } catch (error) {
            alert('An error occurred during registration.');
        }
    };

    const handleSellerLogout = async () => {
        await fetch('/api/seller/logout', { method: 'POST' });
        currentUser = null;
        showSellerAuth();
    };

    // --- SELLER DASHBOARD FUNCTIONS ---
    const showDashboardSection = (section) => {
        document.querySelectorAll('.dashboard-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.dashboard-btn[data-section="${section}"]`).classList.add('active');
        document.querySelectorAll('.dashboard-section').forEach(s => s.classList.add('hidden'));
        document.getElementById(`${section}ProductSection`).classList.remove('hidden');
        if (section === 'manage') loadSellerProducts();
    };

    const handleAddProduct = async (e) => {
        e.preventDefault();
        const data = {
            name: document.getElementById('productName').value,
            category: document.getElementById('productCategory').value,
            price: document.getElementById('productPrice').value,
            originalPrice: document.getElementById('productOriginalPrice').value || document.getElementById('productPrice').value,
            description: document.getElementById('productDescription').value,
            stockQuantity: document.getElementById('productStock').value,
        };

        try {
            const response = await fetch('/api/products/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.success) {
                alert('Product added successfully!');
                e.target.reset();
                showDashboardSection('manage');
            } else {
                alert(`Failed to add product: ${result.message}`);
            }
        } catch (error) {
            alert('An error occurred while adding the product.');
        }
    };

    const loadSellerProducts = async () => {
        const tableContainer = document.getElementById('sellerProductsTable');
        try {
            const response = await fetch('/api/seller/products');
            const data = await response.json();
            if (data.success) {
                displaySellerProducts(data.products);
            } else {
                tableContainer.innerHTML = '<p>Could not load your products.</p>';
            }
        } catch (error) {
            tableContainer.innerHTML = '<p>Error loading your products.</p>';
        }
    };

    const displaySellerProducts = (sellerProducts) => {
        const tableContainer = document.getElementById('sellerProductsTable');
        tableContainer.innerHTML = '';

        if (sellerProducts.length === 0) {
            tableContainer.innerHTML = '<p>You have not added any products yet.</p>';
            return;
        }

        const header = `<div class="table-header">
                            <span>Product</span>
                            <span>Category</span>
                            <span>Price</span>
                            <span>Stock</span>
                            <span>Status</span>
                            <span>Actions</span>
                        </div>`;

        const rows = sellerProducts.map(p => `
            <div class="table-row">
                <div class="product-cell">
                    <img src="https://via.placeholder.com/50x50" alt="${p.name}">
                    <span>${p.name}</span>
                </div>
                <span>${p.category}</span>
                <span>₹${p.price}</span>
                <span>${p.stock_quantity}</span>
                <span class="status active">${p.status}</span>
                <div class="actions">
                    <button class="delete-btn" data-product-id="${p.id}"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `).join('');

        tableContainer.innerHTML = header + rows;
    };

    const deleteProduct = async (productId) => {
        try {
            const response = await fetch(`/api/products/${productId}`, { method: 'DELETE' });
            const result = await response.json();
            if (result.success) {
                alert('Product deleted successfully.');
                loadSellerProducts(); // Refresh the list
            } else {
                alert(`Failed to delete product: ${result.message}`);
            }
        } catch (error) {
            alert('An error occurred while deleting the product.');
        }
    };

    // --- START THE APP ---
    initializeApp();
});
</script>

</body>
</html>